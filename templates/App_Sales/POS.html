{% extends 'layouts/base.html' %}

{% block content %}
<style>
    .container {
        max-width: 900px;
        margin: auto;
        background: #1e1e2f;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.3);
        color: #fff;
        font-family: 'Poppins', sans-serif;
    }
    h2 {
        font-size: 28px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
        color: #fff;
    }
    label {
        font-weight: 600;
        color: #fff;
        display: block;
        margin-bottom: 5px;
    }
    input, select {
        width: 100%;
        padding: 10px;
        border: 1px solid #444;
        border-radius: 8px;
        outline: none;
        background: #2a2a3c;
        color: #fff;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }
    input:focus, select:focus {
        border-color: #3490dc;
    }
    .invoice-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #2a2a3c;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        border: 1px solid #444;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .invoice-item:hover {
        transform: translateY(-5px);
        box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
    }
    .remove-item {
        background: #e3342f;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease;
    }
    .remove-item:hover {
        background: #cc1f1a;
    }
    .add-item-btn {
        background: #3490dc;
        color: white;
        font-weight: bold;
        padding: 12px 20px;
        border-radius: 8px;
        display: block;
        margin: 10px auto;
        text-align: center;
        cursor: pointer;
        transition: background 0.3s ease;
    }
    .add-item-btn:hover {
        background: #2779bd;
    }
    .submit-btn {
        background: #38c172;
        color: white;
        font-weight: bold;
        padding: 15px 25px;
        border-radius: 8px;
        width: 100%;
        text-align: center;
        cursor: pointer;
        transition: background 0.3s ease;
    }
    .submit-btn:hover {
        background: #2d995b;
    }
    #total-cost {
        font-size: 20px;
        font-weight: bold;
        text-align: right;
        margin-top: 20px;
        color: #fff;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        margin-bottom: 10px;
    }
    .form-group input, .form-group select {
        margin-top: 5px;
    }
</style>

<div class="page-wrapper">
	<div class="container">
		<h2>Create Invoice</h2>
		<form method="post" id="invoice-form">
			{% csrf_token %}
			
			<div class="form-group">
				<label>Payment Method</label>
				{{ form.payment_method }}
			</div>
			<div class="form-group">
				<label>Discount</label>
				{{ form.discount }}
			</div>
			
			<h3>Invoice Items</h3>
			{{ formset.management_form }}
			<div id="invoice-items">
				{% for form in formset %}
					<div class="invoice-item">
						<div class="form-group">
							<label>Item</label>
							{{ form.item }}
						</div>
						<div class="form-group">
							<label>Quantity</label>
							{{ form.quantity }}
						</div>
						<div class="form-group">
							<label>Price</label>
							{{ form.price }}
						</div>
						<button type="button" class="remove-item">X</button>
					</div>
				{% endfor %}
			</div>
			<button type="button" id="add-item" class="add-item-btn">+ Add Item</button>
			
			<div id="total-cost">Total: $0.00</div>
			<input type="hidden" id="invoice-payment-amount" name="invoice_payment_amount" value="0">
			
			<button type="submit" class="submit-btn">Create Invoice</button>
		</form>
	</div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        function updatePrice(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const priceField = selectElement.closest(".invoice-item").querySelector("input[name$='-price']");
            const quantityField = selectElement.closest(".invoice-item").querySelector("input[name$='-quantity']");
            
            if (selectedOption.dataset.price) {
                priceField.value = parseFloat(selectedOption.dataset.price).toFixed(2);
                quantityField.value = 1;
            }
        }

        function addItemRow() {
            const totalForms = document.getElementById("id_form-TOTAL_FORMS");
            const currentIndex = parseInt(totalForms.value);
            const newFormHtml = document.querySelector(".invoice-item").outerHTML.replace(/-\d+-/g, `-${currentIndex}-`);
            
            const newForm = document.createElement("div");
            newForm.classList.add("invoice-item");
            newForm.innerHTML = newFormHtml;
            
            // Clear new row fields
            newForm.querySelector("select").selectedIndex = 0;
            newForm.querySelector("input[name$='-quantity']").value = "";
            newForm.querySelector("input[name$='-price']").value = "";

            document.getElementById("invoice-items").appendChild(newForm);
            totalForms.value = currentIndex + 1;
        }

        document.getElementById("invoice-items").addEventListener("change", function (event) {
            if (event.target.tagName === "SELECT") {
                updatePrice(event.target);
            }
        });

        document.getElementById("add-item").addEventListener("click", addItemRow);
    });
</script>

{% endblock %}