{% extends 'layouts/base.html' %}

{% block content %}
<style>
    .container {
        max-width: 900px;
        margin: auto;
        background: black;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
		color: black;
    }
    h2 {
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
        color: black;
    }
    label {
        font-weight: 600;
        color: black;
        display: block;
        margin-bottom: 5px;
    }
    input, select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
        outline: none;
    }
    .invoice-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f9f9f9;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
    }
    .remove-item {
        background: #e3342f;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    .remove-item:hover {
        background: #cc1f1a;
    }
    .add-item-btn {
        background: #3490dc;
        color: white;
        font-weight: bold;
        padding: 10px 15px;
        border-radius: 5px;
        display: block;
        margin: 10px auto;
        text-align: center;
        cursor: pointer;
    }
    .add-item-btn:hover {
        background: #2779bd;
    }
    .submit-btn {
        background: #38c172;
        color: white;
        font-weight: bold;
        padding: 12px 20px;
        border-radius: 5px;
        width: 100%;
        text-align: center;
        cursor: pointer;
    }
    .submit-btn:hover {
        background: #2d995b;
    }
	#total-cost {
        font-size: 18px;
        font-weight: bold;
        text-align: right;
        margin-top: 10px;
        color: #333;
    }
</style>

<div class="page-wrapper">
	<div class="container">
		<h2>Create Invoice</h2>
		<form method="post" id="invoice-form">
			{% csrf_token %}
			
			<div>
				<label>Payment Method</label>
				{{ form.payment_method }}
			</div>
			<div>
				<label>Discount</label>
				{{ form.discount }}
			</div>
			
			<h3>Invoice Items</h3>
			{{ formset.management_form }}
			<div id="invoice-items">
				{% for form in formset %}
					<div class="invoice-item">
						<div>
							<label>Item</label>
							{{ form.item }}
						</div>
						<div>
							<label>Quantity</label>
							{{ form.quantity }}
						</div>
						<div>
							<label>Price</label>
							{{ form.price }}
						</div>
						<button type="button" class="remove-item">X</button>
					</div>
				{% endfor %}
			</div>
			<button type="button" id="add-item" class="add-item-btn">+ Add Item</button>
			
			<div id="total-cost">Total: $0.00</div>
			<input type="hidden" id="invoice-payment-amount" name="invoice_payment_amount" value="0">
			
			<button type="submit" class="submit-btn">Create Invoice</button>
		</form>
	</div>
	
</div>

<script>
    function updateTotal() {
        let total = 0;
        document.querySelectorAll('.invoice-item').forEach(item => {
            const price = parseFloat(item.querySelector('[name$="-price"]').value) || 0;
            const quantity = parseInt(item.querySelector('[name$="-quantity"]').value) || 0;
            total += price * quantity;
        });
        document.getElementById('total-cost').textContent = `Total: $${total.toFixed(2)}`;
        document.getElementById('invoice-payment-amount').value = total;
    }

    document.getElementById('invoice-items').addEventListener('input', updateTotal);
    
    document.getElementById('add-item').addEventListener('click', function() {
        let formIdx = document.querySelectorAll('.invoice-item').length;
        let newForm = document.querySelector('.invoice-item').cloneNode(true);
        newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formIdx);
        document.getElementById('invoice-items').appendChild(newForm);
    });

    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-item')) {
            event.target.closest('.invoice-item').remove();
            updateTotal();
        }
    });

    document.addEventListener('change', function(event) {
        if (event.target.name.endsWith('-item')) {
            fetch(`/get-item-price/${event.target.value}/`)
                .then(response => response.json())
                .then(data => {
                    const priceInput = event.target.closest('.invoice-item').querySelector('[name$="-price"]');
                    priceInput.value = data.price;
                    updateTotal();
                });
        }
    });
</script>

{% endblock %}


